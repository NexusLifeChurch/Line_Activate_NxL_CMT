/**
 * Backend API for NxLife Community Online
 * Google Apps Script (Web App)
 */

const SHEET_ID = '1vg66sWHwsYWZf0zgso_E_WKx-ute4VCs4HxvcBMX5uI'; // SSID ตามที่ระบุ
const SHEET_NAME = 'LineUsers';

function doGet(e) {
  return handleRequest(e);
}

function doPost(e) {
  return handleRequest(e);
}

function handleRequest(e) {
  // Lock Service ป้องกันการเขียนข้อมูลชนกัน
  const lock = LockService.getScriptLock();
  lock.tryLock(10000);

  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const sheet = ss.getSheetByName(SHEET_NAME);
    
    // ถ้ายังไม่มี Sheet ให้สร้าง Header อัตโนมัติ (เผื่อไว้)
    if (sheet.getLastRow() === 0) {
      sheet.appendRow(["RegisteredDate", "LineUserID", "DisplayName", "ProfilePicture", "StatusMessage", "Image", "LineRegisterName"]);
    }

    // รับข้อมูล JSON
    const params = (e.postData && e.postData.contents) ? JSON.parse(e.postData.contents) : {};
    const action = params.action || (e.parameter ? e.parameter.action : null);
    
    let result = {};

    if (action === 'check_user') {
      // ตรวจสอบสถานะ User
      result = checkUserStatus(sheet, params.userId);
    } else if (action === 'register') {
      // ลงทะเบียนหรืออัปเดตข้อมูล
      result = registerUser(sheet, params);
    } else {
      result = { status: 'error', message: 'Invalid Action' };
    }

    return ContentService.createTextOutput(JSON.stringify(result))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  } finally {
    lock.releaseLock();
  }
}

function checkUserStatus(sheet, userId) {
  const data = sheet.getDataRange().getValues();
  // ค้นหา User ID ใน Column 2 (Index 1)
  for (let i = 1; i < data.length; i++) {
    if (data[i][1] == userId) {
      return {
        status: 'found',
        hasRegisterName: (data[i][6] && data[i][6].toString().trim() !== "") ? true : false,
        displayName: data[i][2],
        registerName: data[i][6]
      };
    }
  }
  return { status: 'not_found' };
}

function registerUser(sheet, data) {
  const allData = sheet.getDataRange().getValues();
  let rowIndex = -1;

  // ตรวจสอบว่ามี User นี้อยู่แล้วหรือไม่
  for (let i = 1; i < allData.length; i++) {
    if (allData[i][1] == data.userId) {
      rowIndex = i + 1; // Row number (1-based)
      break;
    }
  }

  const currentDate = Utilities.formatDate(new Date(), "GMT+7", "yyyy-MM-dd HH:mm:ss");
  // Format ชื่อ: ชื่อจริง(ชื่อเล่น) ถ้ามีการส่งมา
  const registerName = data.registerName || ""; 

  if (rowIndex === -1) {
    // === กรณี User ใหม่ (Create) ===
    // Columns: RegisteredDate | LineUserID | DisplayName | ProfilePicture | StatusMessage | Image | LineRegisterName
    sheet.appendRow([
      currentDate,          // 1. RegisteredDate
      data.userId,          // 2. LineUserID
      data.displayName,     // 3. DisplayName
      data.pictureUrl,      // 4. ProfilePicture
      data.statusMessage,   // 5. StatusMessage
      "",                   // 6. Image (เว้นว่างไว้ตาม Requirement ไม่ได้ระบุที่มา)
      registerName          // 7. LineRegisterName
    ]);
  } else {
    // === กรณี User เก่า (Update) ===
    // อัปเดตเฉพาะ LineRegisterName ถ้ามีการส่งค่ามา หรือถ้ายังไม่มีค่า
    // แต่ Requirement บอกว่าถ้า Cancel ไม่เก็บ LineRegisterName (คือส่งค่าว่างมา หรือไม่ส่งมา)
    // ดังนั้นเราจะอัปเดตข้อมูล Profile ล่าสุดเสมอ
    
    sheet.getRange(rowIndex, 3).setValue(data.displayName);     // Update DisplayName
    sheet.getRange(rowIndex, 4).setValue(data.pictureUrl);      // Update Pic
    sheet.getRange(rowIndex, 5).setValue(data.statusMessage);   // Update Status
    
    // อัปเดตชื่อลงทะเบียนเฉพาะเมื่อมีค่าส่งมา (กรณี User กด OK)
    if (registerName !== "") {
        sheet.getRange(rowIndex, 7).setValue(registerName);
    }
  }

  return { status: 'success', message: 'Data saved successfully' };
}
