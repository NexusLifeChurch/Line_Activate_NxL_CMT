/**
 * Configuration
 * ตั้งค่า Sheet ID และชื่อ Sheet ให้ถูกต้อง
 */
const SS_ID = '1vg66sWHwsYWZf0zgso_E_WKx-ute4VCs4HxvcBMX5uI'; // SSID จาก Prompt
const SHEET_NAME = 'LineUsers';

/**
 * doPost(e)
 * รับค่า JSON จาก Frontend เพื่อแก้ปัญหา CORS และ Iframe
 */
function doPost(e) {
  const lock = LockService.getScriptLock();
  try {
    lock.waitLock(10000); // ป้องกันการบันทึกชนกัน

    const data = JSON.parse(e.postData.contents);
    const action = data.action;
    const ss = SpreadsheetApp.openById(SS_ID);
    const sheet = ss.getSheetByName(SHEET_NAME);
    
    if (!sheet) throw new Error("Sheet '" + SHEET_NAME + "' not found.");

    if (action === 'CHECK_USER') {
      return checkUser(sheet, data);
    } else if (action === 'REGISTER') {
      return registerUser(sheet, data);
    } else {
      return responseJSON({ status: 'error', message: 'Unknown action' });
    }

  } catch (err) {
    return responseJSON({ status: 'error', message: err.toString() });
  } finally {
    lock.releaseLock();
  }
}

/**
 * checkUser
 * ตรวจสอบ User และ อ่านค่า MemberID มาแสดงผล (Read Only)
 */
function checkUser(sheet, data) {
  const userId = data.userId;
  const userRowIndex = findRowIndexByUserId(sheet, userId);

  let isUserExist = false;
  let hasRegisterName = false;
  let userData = {};

  if (userRowIndex > 0) {
    isUserExist = true;
    // ดึงข้อมูลมา 9 คอลัมน์เพื่ออ่าน MemberID (Col 9)
    const rowValues = sheet.getRange(userRowIndex, 1, 1, 9).getValues()[0];
    const registerName = rowValues[6]; 
    const memberId = rowValues[8]; // อ่านค่าจริงจาก Sheet (Read Only)

    if (registerName && registerName.toString().trim() !== "") {
      hasRegisterName = true;
    }

    userData = {
      registeredDate: rowValues[0],
      lineRegisterName: registerName,
      memberId: memberId // ส่งค่าไปแสดงผลหน้าบ้าน
    };
  }

  return responseJSON({
    status: 'success',
    isUserExist: isUserExist,
    hasRegisterName: hasRegisterName,
    userData: userData
  });
}

/**
 * registerUser
 * บันทึกข้อมูล (Write) โดยห้ามแตะต้อง MemberID (Col 9)
 */
function registerUser(sheet, data) {
  const userId = data.userId;
  const userRowIndex = findRowIndexByUserId(sheet, userId);
  const timestamp = new Date();
  const payload = data.payload; 
  const registerName = payload.lineRegisterName || ""; 
  const imageFormula = `=IMAGE(INDIRECT("R[0]C[-2]", FALSE))`;

  if (userRowIndex > 0) {
    // --- Update Existing User ---
    sheet.getRange(userRowIndex, 3).setValue(payload.displayName);
    sheet.getRange(userRowIndex, 4).setValue(payload.pictureUrl);
    sheet.getRange(userRowIndex, 5).setValue(payload.statusMessage);
    
    if (payload.updateRegisterName) {
      sheet.getRange(userRowIndex, 7).setValue(registerName);
    }

    // อ่านค่า MemberID เดิมส่งกลับไปแสดงผล (ห้ามแก้ไขค่าใน Sheet)
    const currentMemberId = sheet.getRange(userRowIndex, 9).getValue();
    return responseJSON({ status: 'success', message: 'Updated', memberId: currentMemberId });

  } else {
    // --- Insert New User ---
    // สร้าง Array ข้อมูลแค่ 8 ช่อง (จบที่ Reserved)
    // ตัด Col 9 (MemberID) ออกไปเลย เพื่อให้มั่นใจว่าจะไม่มีการเขียนข้อมูลลงไป
    
    const newRowData = [
      timestamp,                  // 1. RegisteredDate
      userId,                     // 2. LineUserID
      payload.displayName,        // 3. DisplayName
      payload.pictureUrl,         // 4. ProfilePicture
      payload.statusMessage,      // 5. StatusMessage
      imageFormula,               // 6. Image Formula
      registerName,               // 7. LineRegisterName
      ""                          // 8. Reserved
      // 9. MemberID -> ตัดออก ไม่ส่งค่าใดๆ (ปล่อยว่างตามธรรมชาติของ Sheet)
    ];

    sheet.appendRow(newRowData);
    return responseJSON({ status: 'success', message: 'Registered', memberId: "" });
  }
}

function findRowIndexByUserId(sheet, userId) {
  const textFinder = sheet.createTextFinder(userId).matchEntireCell(true);
  const results = textFinder.findAll();
  for (let i = 0; i < results.length; i++) {
    if (results[i].getColumn() === 2) return results[i].getRow();
  }
  return -1;
}

function responseJSON(data) {
  return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON);
}

function doGet(e) { return ContentService.createTextOutput("GAS API is Online."); }
