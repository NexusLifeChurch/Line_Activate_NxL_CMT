<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nexus Life Activation</title>
    
    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <!-- Tailwind CSS (ผ่าน CDN เพื่อความรวดเร็ว) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Prompt -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: 'Prompt', sans-serif; }
        
        /* Coffee Tone Gradient Background */
        .bg-coffee {
            background: linear-gradient(135deg, #F5EDCB 0%, #E6D5B8 50%, #C9A66B 100%);
        }

        /* Nexus Card Gradient */
        .bg-nexus-card {
            background: linear-gradient(135deg, #005bea 0%, #00c6fb 100%);
            box-shadow: 0 10px 25px -5px rgba(0, 91, 234, 0.4);
        }

        /* Loader Animation */
        .loader {
            border-top-color: #8D6E63;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-coffee min-h-screen flex items-center justify-center p-4">

    <!-- Container -->
    <div id="app-container" class="w-full max-w-md bg-white/90 backdrop-blur-sm rounded-2xl shadow-xl overflow-hidden min-h-[400px] relative">
        
        <!-- HEADER DESIGN -->
        <div class="h-2 bg-[#8D6E63] w-full absolute top-0"></div>

        <!-- 1. LOADING SCREEN -->
        <div id="loading-screen" class="flex flex-col items-center justify-center h-[400px] space-y-4">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
            <p class="text-[#6D4C41] font-medium animate-pulse">กำลังเชื่อมต่อข้อมูล...</p>
        </div>

        <!-- 2. FORM SCREEN (ShowForm) -->
        <div id="form-screen" class="hidden p-6">
            <!-- Header Profile -->
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-[#5D4037]">ยินดีต้อนรับ</h2>
                    <p id="form-greeting" class="text-gray-500 italic text-sm mt-1">สวัสดี คุณ...</p>
                </div>
                <div class="relative">
                    <img id="form-profile-img" src="" alt="Profile" class="w-16 h-16 rounded-full border-4 border-white shadow-md object-cover">
                    <div class="absolute bottom-0 right-0 w-4 h-4 bg-green-500 border-2 border-white rounded-full"></div>
                </div>
            </div>

            <!-- Description -->
            <div class="bg-[#FFF8E1] p-4 rounded-lg border border-[#FFE082] mb-6">
                <p class="text-[#6D4C41] text-sm leading-relaxed">
                    เพื่อให้ระบบส่งข้อความที่เหมาะสมกับคุณที่สุด <br>
                    คุณสะดวกให้เราเรียกคุณว่าอะไรดีครับ?
                </p>
            </div>

            <!-- Inputs -->
            <div class="space-y-4 mb-8">
                <div>
                    <label class="block text-[#5D4037] text-sm font-medium mb-1">ชื่อจริง - นามสกุล</label>
                    <input type="text" id="input-realname" placeholder="ตัวอย่าง: สมศรี วงค์พระคริสต์" 
                           class="w-full px-4 py-3 rounded-lg bg-gray-50 border border-gray-200 focus:border-[#8D6E63] focus:ring-2 focus:ring-[#8D6E63]/20 outline-none transition-all">
                </div>
                <div>
                    <label class="block text-[#5D4037] text-sm font-medium mb-1">ชื่อเล่น</label>
                    <input type="text" id="input-nickname" placeholder="ตัวอย่าง: ยาย่า" 
                           class="w-full px-4 py-3 rounded-lg bg-gray-50 border border-gray-200 focus:border-[#8D6E63] focus:ring-2 focus:ring-[#8D6E63]/20 outline-none transition-all">
                </div>
            </div>

            <!-- Buttons -->
            <div class="grid grid-cols-2 gap-4">
                <button onclick="handleCancel()" class="py-3 rounded-lg border border-gray-300 text-gray-500 font-medium hover:bg-gray-50 transition-colors">
                    ยกเลิก
                </button>
                <button onclick="handleSave()" class="py-3 rounded-lg bg-[#8D6E63] text-white font-medium shadow-lg hover:bg-[#6D4C41] transform active:scale-95 transition-all">
                    บันทึกข้อมูล
                </button>
            </div>
        </div>

        <!-- 3. CARD SCREEN (ShowCard) -->
        <div id="card-screen" class="hidden p-6 flex flex-col items-center">
            <h2 class="text-xl font-bold text-[#5D4037] mb-6">Digital Member Card</h2>
            
            <!-- THE CARD -->
            <div class="bg-nexus-card w-full aspect-[1.586/1] rounded-xl relative p-5 text-white shadow-2xl transform transition-transform hover:scale-[1.02] duration-300 mb-8 overflow-hidden">
                <!-- Background Decoration -->
                <div class="absolute top-[-50px] right-[-50px] w-32 h-32 bg-white opacity-10 rounded-full blur-2xl"></div>
                <div class="absolute bottom-[-30px] left-[-30px] w-40 h-40 bg-black opacity-10 rounded-full blur-3xl"></div>

                <!-- Top Row -->
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="text-2xl font-bold tracking-wide">Nexus Life</h3>
                        <p class="text-xs uppercase tracking-[0.2em] opacity-80">Community</p>
                    </div>
                    <img id="card-profile-img" src="" class="w-12 h-12 rounded-full border-2 border-white/50 shadow-sm object-cover">
                </div>

                <!-- Middle Content (Name) -->
                <div class="absolute top-1/2 left-0 w-full transform -translate-y-1/2 px-5 mt-2">
                    <p class="text-xs opacity-70 mb-1">Name / Nickname</p>
                    <h1 id="card-name" class="text-lg font-semibold truncate">...</h1>
                </div>

                <!-- Bottom Row -->
                <div class="absolute bottom-5 left-5 right-5 flex justify-between items-end">
                    <div>
                        <span class="inline-block bg-yellow-400 text-yellow-900 text-[10px] font-bold px-2 py-0.5 rounded shadow-sm">
                            ACTIVATED
                        </span>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] opacity-70">Member ID</p>
                        <p id="card-member-id" class="font-mono text-sm tracking-widest font-medium">Loading...</p>
                    </div>
                </div>
            </div>

            <!-- Confirmation Area -->
            <div class="w-full text-center space-y-4">
                <p class="text-[#6D4C41] text-sm">ข้อมูลถูกต้องหรือไม่?</p>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="editInfo()" class="py-3 rounded-lg border border-[#8D6E63] text-[#8D6E63] font-medium hover:bg-[#F5EDCB] transition-colors">
                        แก้ไขข้อมูล
                    </button>
                    <button onclick="confirmClose()" class="py-3 rounded-lg bg-[#005bea] text-white font-medium shadow-lg hover:bg-[#004bb5] transform active:scale-95 transition-all">
                        ถูกต้องแล้ว
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- CONFIGURATION ---
        const LIFF_ID = "2008560135-06VyMziu"; // จาก Prompt (ถ้าไม่ใช่ให้เปลี่ยน)
        const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbwEPR9FARhVxyQu3_spLb47kue08an21zNlrpOb5Xg7-hr_4Ag3U726Wl-ICUTWY_F3nQ/exec"; 

        // --- GLOBAL STATE ---
        let lineProfile = {};
        let backendData = {};

        // --- DOM ELEMENTS ---
        const screens = {
            loading: document.getElementById('loading-screen'),
            form: document.getElementById('form-screen'),
            card: document.getElementById('card-screen')
        };

        // --- INITIALIZATION ---
        async function main() {
            try {
                await liff.init({ liffId: LIFF_ID });
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                // 1. Get Profile (Fast)
                lineProfile = await liff.getProfile();
                updateUIWithProfile(lineProfile);

                // 2. Check User Status from GAS (Slower)
                checkUserStatus();

            } catch (err) {
                console.error(err);
                Swal.fire('Error', 'ไม่สามารถเชื่อมต่อ LIFF ได้: ' + err.message, 'error');
            }
        }

        // Update UI elements that don't need GAS data
        function updateUIWithProfile(profile) {
            document.getElementById('form-greeting').innerText = `สวัสดี คุณ ${profile.displayName}`;
            document.getElementById('form-profile-img').src = profile.pictureUrl;
            document.getElementById('card-profile-img').src = profile.pictureUrl;
        }

        // Switch Screen Helper
        function showScreen(screenName) {
            Object.values(screens).forEach(el => el.classList.add('hidden'));
            screens[screenName].classList.remove('hidden');
        }

        // --- API INTERACTIONS ---
        async function checkUserStatus() {
            try {
                const response = await fetch(GAS_ENDPOINT, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'CHECK_USER',
                        userId: lineProfile.userId
                    })
                });
                const data = await response.json();
                backendData = data;

                if (data.status === 'success') {
                    if (data.isUserExist && data.hasRegisterName) {
                        // CASE 1: มี User และมีชื่อแล้ว -> Show Card
                        renderCard(data.userData);
                        showScreen('card');
                    } else {
                        // CASE 2: ยังไม่มี User หรือยังไม่มีชื่อ -> Show Form
                        showScreen('form');
                    }
                } else {
                    throw new Error(data.message);
                }

            } catch (err) {
                console.error(err);
                Swal.fire('Error', 'ไม่สามารถเชื่อมต่อฐานข้อมูลได้', 'error');
            }
        }

        async function saveToGAS(updateRegisterName, realName, nickname) {
            // Show Loading
            Swal.fire({
                title: 'กำลังบันทึก...',
                text: 'กรุณารอซักครู่',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            // Format Name: "RealName [Nickname]" or empty
            let finalRegisterName = "";
            if (updateRegisterName && (realName || nickname)) {
                finalRegisterName = `${realName} [${nickname}]`.trim();
            }

            try {
                const response = await fetch(GAS_ENDPOINT, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'REGISTER',
                        userId: lineProfile.userId,
                        payload: {
                            displayName: lineProfile.displayName,
                            pictureUrl: lineProfile.pictureUrl,
                            statusMessage: lineProfile.statusMessage || "",
                            lineRegisterName: finalRegisterName,
                            updateRegisterName: updateRegisterName
                        }
                    })
                });
                const data = await response.json();

                if (data.status === 'success') {
                    Swal.close();
                    
                    // Update Local Data for Card
                    backendData.userData = {
                        lineRegisterName: finalRegisterName || "ไม่ระบุชื่อ",
                        memberId: data.memberId
                    };

                    // Show Card
                    renderCard(backendData.userData);
                    showScreen('card');
                } else {
                    throw new Error(data.message);
                }

            } catch (err) {
                Swal.fire('Error', 'บันทึกข้อมูลไม่สำเร็จ', 'error');
            }
        }

        // --- EVENT HANDLERS ---

        function handleSave() {
            const realName = document.getElementById('input-realname').value.trim();
            const nickname = document.getElementById('input-nickname').value.trim();

            if (!realName) {
                Swal.fire({
                    icon: 'warning',
                    title: 'กรุณากรอกชื่อจริง',
                    text: 'เพื่อสิทธิประโยชน์ของท่าน',
                    confirmButtonColor: '#8D6E63'
                });
                return;
            }

            // User-CHK = true/false handled by GAS logic (Update vs Insert)
            // Just send data
            saveToGAS(true, realName, nickname);
        }

        function handleCancel() {
            if (backendData.isUserExist) {
                // ถ้ามี User อยู่แล้ว กด Cancel คือจบการทำงาน (ปิด LIFF)
                liff.closeWindow();
            } else {
                // ถ้าเป็น User ใหม่ กด Cancel -> บันทึกพื้นฐาน (ไม่เอา RegisterName) -> แล้วจบ
                saveToGAS(false, "", "").then(() => {
                    // หลังจาก save basic success, show card or close? 
                    // Prompt says: "ShowCard" after update.
                });
            }
        }

        function editInfo() {
            // Parse Name Back to Inputs
            // Format: "RealName [Nickname]"
            const currentName = backendData.userData.lineRegisterName || "";
            const match = currentName.match(/^(.*)\s\[(.*)\]$/);
            
            if (match) {
                document.getElementById('input-realname').value = match[1];
                document.getElementById('input-nickname').value = match[2];
            } else {
                document.getElementById('input-realname').value = currentName;
            }
            
            showScreen('form');
        }

        function confirmClose() {
            Swal.fire({
                icon: 'success',
                title: 'ขอบคุณครับ',
                text: 'ระบบได้ยืนยันข้อมูลเรียบร้อยแล้ว',
                showConfirmButton: false,
                timer: 1500
            }).then(() => {
                liff.closeWindow();
            });
        }

        function renderCard(userData) {
            const nameEl = document.getElementById('card-name');
            const idEl = document.getElementById('card-member-id');

            nameEl.innerText = userData.lineRegisterName || "ไม่ระบุชื่อ";
            idEl.innerText = userData.memberId || "V26-XXXX";
        }

        // Start App
        main();

    </script>
</body>
</html>
